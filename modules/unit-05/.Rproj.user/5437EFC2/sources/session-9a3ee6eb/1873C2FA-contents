---
title: "Linear Additive Model"
output: html_document
---

# Introduction
The linear additive model may seem a very esoteric concept in data science, but it is critical to understand how we make predictions from statistical models, and how we test whether those models significantly explain the variance in our observations. It also underscores an important concept in statistical modelling: the assumption that the different effects that combine to explain an observed value are *additive*.

# Case Study: Barley Effects
The barley dataset is the same we used in the other exercises, except I have calculated the population mean, mu, treatment effet, and error effect.  Ignore the last four columns -- those were calculated only to create the chart you will run below.

```{r}
library(tidyverse)
barley_effects = read.csv("data/barley_effects_table.csv")
barley_effects

```
## Plotting the Effects

Below is the code to create a bar plot.  This kind of bar plot is *stacked* -- it shows multiple measures for each observation (plot), stacked on top each other.  Normally, a stacked bar plot can be created in a couple of lines of code -- the intricate code below was so I could customize the order of stacking for each plot.  Run the code and observe the plot.

```{r, fig.width=12, fig.height=10}
ggplot(barley_effects) +
  geom_segment(aes(x=plot, y=0, xend=plot, yend=mu), color="lightblue", size=14) +
  geom_segment(aes(x=plot, xend=plot, y=trt_bar_min, yend=trt_bar_max), color="lightgreen", size=14) +
  geom_segment(aes(x=plot, xend=plot, y=err_bar_min, yend=err_bar_max), color="tomato", size=14) +
  # geom_point(aes(x=plot, y=y), size=4) +
  geom_text(aes(x=plot, y=mu/2, label= mu)) +
  geom_text(aes(x=plot, y=trt_bar_min+(trt_bar_max-trt_bar_min)/2, label=trt_effect)) +
  geom_text(aes(x=plot, y=err_bar_min+(err_bar_max-err_bar_min)/2, label=error_effect)) +
  geom_segment(aes(x=plot+0.4, xend=plot+0.2, y=y, yend=y), arrow = arrow(length = unit(0.01, "npc")), size=1) +
  geom_text(aes(x=plot+0.4, y=y, label=y), hjust=0) +
  scale_x_continuous(breaks=c(1:10))
```

If this plot is too big to fit comfortably on this screen, remember you can knit this code using the menu immediately above this window, and either view it in HTML or print it out to use.

What I have tried to do with this plot is to visualize the additive effects of the population mean (light blue bar), treatment effect (green bar), and error effect (red bar).  The sum of their effects (the observed value) is shown by a black arrow to the right of each bar.

The blue bars are the same, 312.3, reflecting that the population mean for the whole trial does not change: every plot starts out with this same value, with the effects then adding or subtracting from its observed value.

Looking at this plot, you can see half of the green bars have a treatment effect of 26.8, while the other half have a treatment effect of -26.8.  In a two treatment trial, the treatment effects will be exactly opposite for the two levels of treatment.  If we look at the plot above, we can see the positive treatment effect is associated with the new genotype, and the negative effect with the old genotype.

The red bars represent the error.  This is the unexplained variance in observed value.  Part of it reflects how, try as hard as we might, not every plot has exactly the same environment.  Soil types and microclimates differ.  Plot lengths may differ slightly among plots.  One plot may be planted more evenly than others.  A fertilizer applicator might skip.  An ear might bounce out of the combine.  Note that the errors are negative in some cases and positive in others.  In addition, they are not consistent -- their values are random. 

The treatment effect above is an example of a *fixed effect* -- it has a specific, consistent effect, based on the level of treatment.

The error effect above is an example of a *random effect*.  Its value varies from plot to plot.  Its variation usually follows a normal distribution with a mean close to zero.  Lets run the histogram below and check.

```{r}
hist(barley_effects$error_effect)
mean(barley_effects$error_effect)
```

## Examining Individual Plots

We can see 

Recall our linear model is: Yij = mu + Ti + e(i)j

Y(i)j is the observed value for plot j that has received treatment i.  mu is the population mean.  Ti is the treatment effect associated with level i.  e(i)j is the 

So let's plug a few plots into this equation and see how it works.

In plot 2: 
- Yij = 223.9
- mu = 312.3, 
- Ti, associated with the old hybrid = -26.8
- e(i)j, associated with plot 2, = -61.6

Our model for plot 2, then is:  223.9 = 312.3 - 26.8 - 61.6


What about for plot 5?

Yij = 399.3
mu = 312.3
- Ti, associated with the new hybrid = +26.8
- e(i)j, associated with plot 5 =  +60.2

Our model for plot 5, then is:  399.3 = 312.3 + 26.8 + 60.2


What about for plot 8?

Yij = 349.8
mu = 312.3
- Ti, associated with the old hybrid = -26.8
- e(i)j, associated with plot 8 =  +64.3

Our model for plot 8, then is:  349.8 = 312.3 - 26.8 + 64.3

What is interesting in this last example is that the positive error "masks" the negative effect of the treatment -- the yield with the old hybrid, in this case, is greater than plots 3 and 9, which received the old hybrid!  This underscores why it is important to break down the effects behind an observation to better understand the true contribution of each treatment level.


## Practice: Groudnut
Let's load and plot the groundnut data from the other exercises this unit.  Like the barley data above, we have added several columns in order to calculate treatment and error effects and to draw the plot below.

```{r}
groundnut_effects = read.csv("data/groundnut_effects_table.csv")
groundnut_effects

```
## Plotting the Effects

Below is the code to create a bar plot.  This kind of bar plot is *stacked* -- it shows multiple measures for each observation (plot), stacked on top each other.  Normally, a stacked bar plot can be created in a couple of lines of code -- the intricate code below was so I could customize the order of stacking for each plot.  Run the code and observe the plot.

```{r, fig.width=12, fig.height=10}
ggplot(groundnut_effects) +
  geom_segment(aes(x=plot, y=0, xend=plot, yend=mu), color="lightblue", size=14) +
  geom_segment(aes(x=plot, xend=plot, y=trt_bar_min, yend=trt_bar_max), color="lightgreen", size=14) +
  geom_segment(aes(x=plot, xend=plot, y=err_bar_min, yend=err_bar_max), color="tomato", size=14) +
  # geom_point(aes(x=plot, y=y), size=4) +
  geom_text(aes(x=plot, y=mu/2, label= mu)) +
  geom_text(aes(x=plot, y=trt_bar_min+(trt_bar_max-trt_bar_min)/2, label=trt_effect)) +
  geom_text(aes(x=plot, y=err_bar_min+(err_bar_max-err_bar_min)/2, label=error_effect)) +
  geom_segment(aes(x=plot+0.4, xend=plot+0.2, y=y, yend=y), arrow = arrow(length = unit(0.01, "npc")), size=1) +
  geom_text(aes(x=plot+0.4, y=y, label=y), hjust=0) +
  scale_x_continuous(breaks=c(1:10))
```

Model plots 1, 5, and 6, using the linear model as we did above.

